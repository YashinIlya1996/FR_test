Документация по запуску проекта.
============
----
### Подробное описание последовательности запуска:
Последовательность действий описана для заново установленной Unix операционной системы (Debian, Ubuntu), в которых python установлен из коробки.
###### Последовательность операций:
1. Создание нового пользователя, upgrade ОС (опционально):
```
adduser <username>
usermod -aG sudo <username>
su <username>
cd ~
sudo apt update
sudo apt upgrade
```  
2. Установка nginx, Redis, PostgreSQL, Git:  
`sudo apt install git postgresql redis nginx`  
3. Создание базы данных и нового пользователя базы данных:
```
sudo -u postgres psql
CREATE DATABASE <DB_NAME>;
CREATE USER <DB_USER> WITH PASSWORD '<DB_PASSWORD>';
ALTER ROLE <DB_USER> SET client_encoding TO 'utf8';
ALTER ROLE <DB_USER> SET default_transaction_isolation TO 'read committed';
GRANT ALL PRIVILEGES ON DATABASE <DB_NAME> TO <DB_USER>;
\q
```  
4. Создание и активация виртуальной среды:  
```
cd ~
pyton -m venv venv
source venv/bin/activate
```  
5. Клонирование репозитория, установка зависимостей:
```
git clone https://gitlab.com/YashinIlya1996/fr_test.git
mv fr_test/ FR_test/
cd FR_test/
pip install -r requirements.txt
```  
6. Для хранения чувствительных данных в проекте используется файл `secrets.json`, который по понятным причинам не выложен в репозиторий. Для указания данных необходимо создать json файл следуюшего содержания:  
`touch secrets.json`
```
{
  "API_TOKEN": <Токен доступа к внешнему сервису рассылки>,
  "SECRET_KEY": <SECRET_KEY django проекта>,
  "DB_NAME": <DB_NAME>, 
  "DB_HOST": "127.0.0.1", 
  "DB_PORT": 5432,
  "DB_USER": <DB_USER>, 
  "DB_PASSWORD": <DB_PASSWORD> 
}
```
Значения <DB_NAME>, <DB_USER>, <DB_PASSWORD> должны соответствовать значениям, указанным на 3 шаге.  
7. Создание log-файлов:
```
cd ~/FR_test/
mkdir logs
touch logs/celery.log logs/celery_err.log logs/gunicorn.log logs/guncorn_err.log
```  
8. (Опционально): Для первичного заполнения БД можно выполнить команду  
`python manage.py create_test_data`
Будут созданы:
    * 100 объектов OperatorCode (со значениями от 900 до 999)
    * 10 объектов ClientTag
    * 500 объектов Client, каждому присвоен номер телефона, тэг и код мобильного оператора  

7. В ходе работы над заданием выявлен bug в библиотеке Celery, связанный с изменением типа datetime на str в параметре `expires` при повторном выполнении неудавшихся задач. Как выяснилось, на эту тему уже создан [bug report](https://github.com/celery/celery/issues/7091) и принят разработчиками. На данный момент не исправлен. Для фикса бага в рамках данного проекта выполнить:  
`cp ~/FR_test/celery_bugfix/base.py ~/venv/lib/python3.9/site-packages/celery/app/base.py`  
8. Запуск gunicorn, Redis и Celery:
```
cd ~/FR_test/
gunicorn FR_test.wsgi:application -c ~/FR_test/conf/gunicorn.conf.py >> ~/FR_test/logs/gunicorn.log 2>> ~/FR_test/logs/gunicorn_err.log&
redis-server & celery -A FR_test worker -l info >> logs/celery.log 2>> logs/celery_err.log &
```
11. Дополнительно требуется в файле `~/FR_test/conf/gunicorn.conf.py` изменить имя пользователя на имя пользователя ОС (шаг 1). 
В файле `~/FR_test/FR_test/prod_settings.py` в список `ALLOWED_HOSTS` добавить IP-адрес сервера, на котором производится деплой.  
11. Конфигурация и перезапуск nginx:
```
sudo cp ~/FR_test/conf/nginx/default /etc/nginx/sites-available/default
sudo service nginx restart
```
----------------------------
### Детали реализации
##### Дополнительные задания:
Реализованы дополнительные задания под номерами 5 и 9.
    5. Увидеть описание разработанного API в формате Swagger UI можно увидеть по адресу http://77.223.97.240/docs/ (произведен деплой проекта). 
    9. Производится повторная отправка сообщений как при исключениях, возникающих в процессе отправки запроса на внешний сервис, так и при коде ответа от внешнего сервиса, отличающегося от 200. Повтор происходит вплоть до времени окончания рассылки с увеличивающимся промежутком времени между последующими попытками. Максимальное время между попытками ограничено десятью минутами.
  
Так как часть реализации была на усмотрение разработчика, стоит рассказать о следующих принятых решениях:
* При создании клиента с отсутствующими тэгом или кодом оператора, код и тэг будут созданы в БД;
* При создании списка рассылки возможен вариант, когда фильтры как по кодам, так и тэгам будут не указаны, или пусты. В этом случае по умолчанию будет произведена рассылка всем клиентам. Поведение можно изменить значением параметра `EMPTY_FILTERS_IN_MAILING_TO_ALL_CLIENTS` (по умолчанию `True`) в файле `settings.py`. При установке в `False` с отсутствующими фильтрами рассылка не будет произведена.
* При изменении параметров рассылки после ее создания возможны различные сценарии. Реализованы следующие:
    * При изменении текста сообщения будет произведена повторная отправка всем клиентам, попадающим под фильтры, в соответствии со временем рассылки.
    * При изменении даты/времени или фильтров повторная отправка сообщений клиентам, которым уже было успешно доставлено сообщение, производиться не будет. (Повторная отправка неуспешных сообщений и новым клиентам в соответствии с новыми фильтрами)
* В списке рассылок указывается краткая статистика: Общее количество сообщений, количество успешных, проваленных и запланированных к отправке.
* В детальной статистике дополнительно отображаются данные по каждому сообщению (номер, на который было отправлено сообщение, статус, время отправки, id сообщения)
* При удалении рассылки отправка запланированных сообщений отменяется.
* Поддерживаются CRUD операции с объектами клиента и рассылки